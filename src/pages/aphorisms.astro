---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

// Get all aphorisms and sort them by order
const aphorisms = await getCollection('aphorisms');
const sortedAphorisms = aphorisms.sort((a, b) => a.data.order - b.data.order);
---

<Layout title="Aphorisms - Aaron Zollman" description="Wisdom cards with practical insights">
    <!-- Full viewport container that breaks out of the main layout constraints -->
    <div id="viewport-container" class="fixed inset-0 bg-base-100 flex items-center justify-center p-4 z-10">
        <div id="content-wrapper" class="w-full max-w-md relative">
            <!-- Header positioned above the centered card -->
            <div id="header-section" class="absolute -top-20 left-0 right-0 text-center">
                <h1 class="text-3xl font-bold text-base-content mb-2">Aphorisms</h1>
                <p class="text-base-content/70">Wisdom cards for practical insights</p>
            </div>
            
            <!-- This container is now the centered element -->
            <div id="aphorism-container" class="relative">
                {sortedAphorisms.map((aphorism, index) => (
                    <div 
                        class={`aphorism-card absolute w-full transition-all duration-300 ${index === 0 ? 'opacity-100 translate-x-0' : 'opacity-0 translate-x-full'}`}
                        data-index={index}
                    >
                        <div class="card bg-base-200 shadow-xl border border-base-300 min-h-[500px] flex flex-col">
                            <div class="card-body p-8 flex-1 flex flex-col justify-between">
                                <div class="flex-1 flex flex-col justify-center items-center text-center space-y-6">
                                    <div class="text-6xl mb-4">
                                        {aphorism.data.icon || 'ðŸ’¡'}
                                    </div>
                                    <h2 class="text-xl font-bold text-base-content leading-tight">
                                        {aphorism.data.title}
                                    </h2>
                                    <p class="text-base-content/80 text-sm leading-relaxed">
                                        {aphorism.data.description}
                                    </p>
                                </div>
                                <div class="flex justify-between items-center mt-6">
                                    <div class="text-xs text-base-content/50">
                                        {index + 1}/{sortedAphorisms.length}
                                    </div>
                                    {/* Show references button only if references exist */}
                                    {aphorism.data.references && aphorism.data.references.length > 0 && (
                                        <button 
                                            class="btn btn-ghost btn-xs p-1 hover:bg-base-300 references-btn"
                                            data-card-index={index}
                                            title="View references"
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                            </svg>
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
            
            <!-- Navigation positioned below the centered card -->
            <div id="navigation-section" class="absolute -bottom-20 left-0 right-0">
                <div id="button-controls" class="flex justify-center space-x-4 mb-4">
                    <button id="prev-btn" class="btn btn-circle btn-outline btn-sm" disabled>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <button id="next-btn" class="btn btn-circle btn-outline btn-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="dot-indicators" class="flex justify-center space-x-2">
                    {sortedAphorisms.map((_, index) => (
                        <button 
                            class={`w-2 h-2 rounded-full transition-all ${index === 0 ? 'bg-primary' : 'bg-base-content/20'}`}
                            data-dot={index}
                        ></button>
                    ))}
                </div>
            </div>
        </div>
    </div>
    
    <!-- References overlay modal -->
    <div id="references-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20 hidden">
        <div class="bg-base-200 rounded-lg shadow-xl max-w-md w-full max-h-80 overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-base-content">References</h3>
                    <button id="close-references" class="btn btn-ghost btn-sm btn-circle">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="references-content" class="space-y-3">
                    <!-- References will be populated here -->
                </div>
            </div>
        </div>
    </div>
</Layout>

<script define:vars={{ aphorismsReferences: sortedAphorisms.map((aphorism, index) => ({
    index, 
    references: aphorism.data.references || null
})) }}>
    // Store references data globally for client-side access
    window.aphorismsReferences = aphorismsReferences;
</script>

<script is:inline>
    // Global state for card navigation and UI elements
    let currentIndex = 0;
    let cards = [];
    let totalCards = 0;
    let prevBtn = null;
    let nextBtn = null;
    let dots = [];
    let container = null;
    let referencesOverlay = null;
    let referencesContent = null;
    let closeReferencesBtn = null;
    
    // Initialize the aphorisms interface
    function init() {
        cards = Array.from(document.querySelectorAll('.aphorism-card'));
        totalCards = cards.length;
        prevBtn = document.getElementById('prev-btn');
        nextBtn = document.getElementById('next-btn');
        dots = Array.from(document.querySelectorAll('[data-dot]'));
        container = document.getElementById('aphorism-container');
        referencesOverlay = document.getElementById('references-overlay');
        referencesContent = document.getElementById('references-content');
        closeReferencesBtn = document.getElementById('close-references');
        
        // Navigation event listeners
        if (prevBtn) {
            prevBtn.addEventListener('click', () => previousCard());
        }
        if (nextBtn) {
            nextBtn.addEventListener('click', () => nextCard());
        }
        
        dots.forEach((dot, index) => {
            dot.addEventListener('click', () => goToCard(index));
        });
        
        // References functionality
        const referenceBtns = document.querySelectorAll('.references-btn');
        referenceBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const cardIndex = parseInt(btn.getAttribute('data-card-index'));
                const referencesData = window.aphorismsReferences.find(item => item.index === cardIndex);
                if (referencesData && referencesData.references) {
                    showReferences(referencesData.references);
                }
            });
        });
        
        // Modal event listeners
        if (closeReferencesBtn) {
            closeReferencesBtn.addEventListener('click', hideReferences);
        }
        
        if (referencesOverlay) {
            referencesOverlay.addEventListener('click', (e) => {
                if (e.target === referencesOverlay) {
                    hideReferences();
                }
            });
        }
        
        // Touch/swipe support
        let startX = 0;
        let startY = 0;
        let endX = 0;
        let endY = 0;
        
        if (container) {
            container.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });
            
            container.addEventListener('touchmove', (e) => {
                e.preventDefault();
            });
            
            container.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].clientX;
                endY = e.changedTouches[0].clientY;
                
                const deltaX = endX - startX;
                const deltaY = endY - startY;
                
                // Only trigger swipe if horizontal movement is greater than vertical
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                    if (deltaX > 0) {
                        previousCard();
                    } else {
                        nextCard();
                    }
                }
            });
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                previousCard();
            } else if (e.key === 'ArrowRight') {
                nextCard();
            }
        });
        
        updateUI();
    }
    
    function showReferences(references) {
        if (!referencesContent || !referencesOverlay) return;
        
        referencesContent.innerHTML = '';
        references.forEach(ref => {
            const refDiv = document.createElement('div');
            refDiv.className = 'p-3 bg-base-100 rounded border border-base-300';
            
            const title = document.createElement('h4');
            title.className = 'font-semibold text-base-content mb-1';
            title.textContent = ref.title;
            
            const author = document.createElement('p');
            author.className = 'text-sm text-base-content/70 mb-2';
            author.textContent = ref.author || 'Unknown Author';
            
            const link = document.createElement('a');
            link.href = ref.url;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.className = 'text-sm text-primary hover:text-primary-focus underline';
            link.textContent = 'View Reference â†’';
            
            refDiv.appendChild(title);
            refDiv.appendChild(author);
            refDiv.appendChild(link);
            referencesContent.appendChild(refDiv);
        });
        
        referencesOverlay.classList.remove('hidden');
    }
    
    function hideReferences() {
        if (referencesOverlay) {
            referencesOverlay.classList.add('hidden');
        }
    }
    
    function goToCard(index) {
        if (index >= 0 && index < totalCards) {
            currentIndex = index;
            updateUI();
        }
    }
    
    function nextCard() {
        if (currentIndex < totalCards - 1) {
            currentIndex++;
            updateUI();
        }
    }
    
    function previousCard() {
        if (currentIndex > 0) {
            currentIndex--;
            updateUI();
        }
    }
    
    function updateUI() {
        // Update cards
        cards.forEach((card, index) => {
            if (index === currentIndex) {
                card.classList.remove('opacity-0', 'translate-x-full', '-translate-x-full');
                card.classList.add('opacity-100', 'translate-x-0');
            } else if (index < currentIndex) {
                card.classList.remove('opacity-100', 'translate-x-0', 'translate-x-full');
                card.classList.add('opacity-0', '-translate-x-full');
            } else {
                card.classList.remove('opacity-100', 'translate-x-0', '-translate-x-full');
                card.classList.add('opacity-0', 'translate-x-full');
            }
        });
        
        // Update buttons
        if (prevBtn) {
            prevBtn.disabled = currentIndex === 0;
        }
        if (nextBtn) {
            nextBtn.disabled = currentIndex === totalCards - 1;
        }
        
        // Update dots
        dots.forEach((dot, index) => {
            if (index === currentIndex) {
                dot.classList.remove('bg-base-content/20');
                dot.classList.add('bg-primary');
            } else {
                dot.classList.remove('bg-primary');
                dot.classList.add('bg-base-content/20');
            }
        });
    }
    
    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        init();
    });
</script>

<style>
    .aphorism-card {
        height: 500px;
    }
    
    /* Responsive card heights */
    @media (max-width: 640px) {
        .aphorism-card {
            height: 450px;
        }
    }
    
    @media (max-height: 600px) {
        .aphorism-card {
            height: 350px;
        }
    }
    
    /* Ensure container matches card height */
    #aphorism-container {
        height: 500px;
    }
    
    @media (max-width: 640px) {
        #aphorism-container {
            height: 450px;
        }
    }
    
    @media (max-height: 600px) {
        #aphorism-container {
            height: 350px;
        }
    }
</style>
